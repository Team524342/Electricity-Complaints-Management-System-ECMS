<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electricity Complaint Management System</title>
     <link rel="stylesheet" href="static/bootstrap-5.3.6-dist/css/bootstrap.min.css">
     <script src="static/bootstrap-5.3.6-dist/js/bootstrap.bundle.min.js"></script>
     <link rel="stylesheet" href="static/fontawesome-free-6.7.2-web/css/all.min.css">
     <script src="chart.js"></script>
     <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
</head>
<body>
    <div class="loading" id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <header>
        <div class="header-container">
            <div class="logo-section">
                <i class="fas fa-bolt logo-icon"></i>
                <h1>Electricity Complaint Management System</h1>
            </div>
            
            <div class="dark-mode-toggle">
                <label class="switch">
                    <input type="checkbox" id="darkModeSwitch">
                    <span class="slider round"></span>
                </label>
            </div>
            <nav>
                <ul>
                    {% if request.path != '/' %}
                        <li><a href="/">Home</a></li>
                    {% endif %}
                    {% if 'user_id' in session %}
                        {% if session['role'] == 'admin' %}
                            {% if request.path != '/admin_dashboard' %}
                                <li><a href="/admin_dashboard">Dashboard</a></li>
                            {% endif %}    
                        {% elif session['role'] == 'technician' %}
                            {% if request.path != '/technician_dashboard' %}
                                <li><a href="/technician_dashboard">Dashboard</a></li>
                            {% endif %}
                        {% else %}
                            {% if request.path != '/user_dashboard' %}
                                <li><a href="/user_dashboard">Dashboard</a></li>
                            {% endif %}    
                        {% endif %}
                            <li><a href="/logout">({{ session['username'] }})Logout</a></li>
                    {% else %}
                        {% if request.path != '/login'%}
                            <li><a href="/login">Login</a></li>
                        {% endif %}
                        {% if request.path != '/register' %}
                            <li><a href="/register">Register</a></li>
                        {% endif %}
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>
    
    <main class="container" style="min-height: 130vh; margin-top: 50px;; ">
        <div id="flashMessages"></div>
        
        
        {% block content %}
        {% endblock %}
    </main>
    
    <footer>
        <div class="container" >
            <p>&copy; 2025 Electricity Complaint Management System | Powered by Modern Web Technologies</p>
        </div>
    </footer>

    <div id="notification" class="notification"></div>

    <script>
        // Global State Management
        const AppState = {
            darkMode: false,
            user: null,
            notifications: [],
            complaints: []
        };

        // Dark Mode Toggle
        function initDarkMode() {
            const darkModeSwitch = document.getElementById('darkModeSwitch');
            const savedMode = localStorage.getItem('darkMode') === 'true';
            
            darkModeSwitch.checked = savedMode;
            AppState.darkMode = savedMode;
            
            if (savedMode) {
                document.body.classList.add('dark-mode');
            }
            
            darkModeSwitch.addEventListener('change', function() {
                AppState.darkMode = this.checked;
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', this.checked);
                
                showNotification(
                    this.checked ? 'Dark mode enabled' : 'Light mode enabled',
                    'success'
                );
            });
        }

        // Notification System
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // Loading Spinner
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        // Flash Messages Handler
        function displayFlashMessage(message, category) {
            const flashContainer = document.getElementById('flashMessages');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${category} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            flashContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Statistics Animation
        function animateStats() {
            const statNumbers = document.querySelectorAll('.stat-number');
            
            statNumbers.forEach(stat => {
                const target = parseInt(stat.textContent.replace(/,/g, ''));
                const increment = target / 100;
                let current = 0;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    
                    if (stat.id === 'avgResponseTime') {
                        stat.textContent = current.toFixed(1);
                    } else {
                        stat.textContent = Math.floor(current).toLocaleString();
                    }
                }, 20);
            });
        }

        // Show Features Section
        function showFeatures() {
            const featuresSection = document.getElementById('featuresSection');
            featuresSection.style.display = featuresSection.style.display === 'none' ? 'block' : 'none';
            
            if (featuresSection.style.display === 'block') {
                featuresSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

       
        // AJAX Helper Function
        async function makeRequest(url, options = {}) {
            showLoading();
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                hideLoading();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Request failed');
                }
                
                return data;
            } catch (error) {
                hideLoading();
                showNotification(error.message, 'danger');
                throw error;
            }
        }

        // Real-time Updates (Placeholder for WebSocket connection)
        function initRealTimeUpdates() {
            // This would connect to a WebSocket server for real-time updates
            // For demo purposes, we'll simulate updates
            setInterval(() => {
                const activeComplaints = document.getElementById('activeComplaints');
                if (activeComplaints) {
                    const current = parseInt(activeComplaints.textContent.replace(/,/g, ''));
                    const change = Math.floor(Math.random() * 5) - 2; // Random change -2 to +2
                    const newValue = Math.max(0, current + change);
                    activeComplaints.textContent = newValue.toLocaleString();
                }
            }, 30000); // Update every 30 seconds
        }

        // Smooth Scrolling for Anchor Links
        function initSmoothScrolling() {
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        }

       

        // Keyboard Shortcuts
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Alt + D for dark mode toggle
                if (e.altKey && e.key === 'd') {
                    e.preventDefault();
                    const darkModeSwitch = document.getElementById('darkModeSwitch');
                    darkModeSwitch.click();
                }
                
                // Alt + H for home
                if (e.altKey && e.key === 'h') {
                    e.preventDefault();
                    window.location.href = '/';
                }
                
                // Alt + L for login
                if (e.altKey && e.key === 'l') {
                    e.preventDefault();
                    window.location.href = '/login';
                }
                
                // Escape to close modals/notifications
                if (e.key === 'Escape') {
                    const notification = document.getElementById('notification');
                    if (notification.classList.contains('show')) {
                        notification.classList.remove('show');
                    }
                }
            });
        }

        // Progressive Web App Features
        function initPWA() {
            // Register service worker for offline functionality
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            }
            
            // Handle app install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button or banner
                const installButton = document.createElement('button');
                installButton.className = 'btn btn-primary position-fixed bottom-0 end-0 m-3';
                installButton.innerHTML = '<i class="fas fa-download"></i> Install App';
                installButton.onclick = () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the A2HS prompt');
                        }
                        deferredPrompt = null;
                        installButton.remove();
                    });
                };
                document.body.appendChild(installButton);
            });
        }

        // Data Visualization
        function createComplaintChart() {
            const ctx = document.getElementById('complaintChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'In Progress', 'Resolved', 'Closed'],
                    datasets: [{
                        // ... your chart data and options ...
                    }]
                }
            });
        }
        
        // Initialize all functions on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            initDarkMode();
            // Assuming your backend dynamically provides the user role for navigation update
            // updateNavigation('{{ session.get("role") }}'); 
            // setActiveNavItem(); // Call this after navigation is updated
            animateStats(); // Call this if you have elements with stat-number class
            setupFormHandlers();
            initKeyboardShortcuts();
            initPWA();
            createComplaintChart(); // Call this if you have a canvas with id 'complaintChart'
            initRealTimeUpdates(); // For the simulated updates
        });
    </script>
</body>
</html>