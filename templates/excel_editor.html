
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Data Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .file-info {
            background-color: #f0f8ff;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #333;
            border-left: 4px solid #4b93d6;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        button {
            cursor: pointer;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            margin-right: 5px;
        }
        .btn-add {
            background-color: #4CAF50;
            color: white;
            margin-bottom: 20px;
        }
        .btn-edit {
            background-color: #2196F3;
            color: white;
        }
        .btn-delete {
            background-color: #f44336;
            color: white;
        }
        .btn-save {
            background-color: #4CAF50;
            color: white;
        }
        .btn-cancel {
            background-color: #ccc;
        }
        .nav-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #0066cc;
            text-decoration: none;
        }
        .form-row {
            margin-bottom: 15px;
        }
        .form-row label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-container {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .hidden {
            display: none;
        }
        .actions {
            white-space: nowrap;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="nav-link">‚Üê Back to Home</a>
        <h1>Excel Data Editor</h1>
        
        <div class="file-info">
            Currently editing: <strong>{{ excel_file }}</strong> (Sheet: {{ sheet_name }})
        </div>
        
        <button id="btnShowAddForm" class="btn-add">Add New Record</button>
        
        <div id="addFormContainer" class="form-container hidden">
            <h2>Add New Record</h2>
            <form id="addForm">
                <div id="addFormFields"></div>
                <button type="submit" class="btn-save">Save</button>
                <button type="button" class="btn-cancel" id="btnCancelAdd">Cancel</button>
            </form>
        </div>
        
        <div id="editFormContainer" class="form-container hidden">
            <h2>Edit Record</h2>
            <form id="editForm">
                <div id="editFormFields"></div>
                <input type="hidden" id="editRecordId">
                <button type="submit" class="btn-save">Update</button>
                <button type="button" class="btn-cancel" id="btnCancelEdit">Cancel</button>
            </form>
        </div>
        
        <div id="loading" class="loading">Loading data...</div>
        
        <table id="dataTable">
            <thead>
                <tr id="headerRow"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Base URL for API endpoints - adjust this path as needed
            const baseUrl = window.location.pathname;
            
            // Get elements
            const dataTable = document.getElementById('dataTable');
            const tableBody = document.getElementById('tableBody');
            const headerRow = document.getElementById('headerRow');
            const addForm = document.getElementById('addForm');
            const editForm = document.getElementById('editForm');
            const addFormFields = document.getElementById('addFormFields');
            const editFormFields = document.getElementById('editFormFields');
            const addFormContainer = document.getElementById('addFormContainer');
            const editFormContainer = document.getElementById('editFormContainer');
            const btnShowAddForm = document.getElementById('btnShowAddForm');
            const btnCancelAdd = document.getElementById('btnCancelAdd');
            const btnCancelEdit = document.getElementById('btnCancelEdit');
            const editRecordId = document.getElementById('editRecordId');
            const loading = document.getElementById('loading');
            
            let columns = [];
            
            // Fetch table columns
            fetch(`${baseUrl}columns`)
                .then(response => response.json())
                .then(data => {
                    columns = data.columns;
                    
                    // Create table headers
                    columns.forEach(column => {
                        if (column !== 'id') {
                            const th = document.createElement('th');
                            th.textContent = column;
                            headerRow.appendChild(th);
                        }
                    });
                    
                    // Add actions column
                    const actionsHeader = document.createElement('th');
                    actionsHeader.textContent = 'Actions';
                    headerRow.appendChild(actionsHeader);
                    
                    // Create add form fields
                    columns.forEach(column => {
                        if (column !== 'id') {
                            const formRow = document.createElement('div');
                            formRow.className = 'form-row';
                            
                            const label = document.createElement('label');
                            label.setAttribute('for', `add_${column}`);
                            label.textContent = column;
                            
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.id = `add_${column}`;
                            input.name = column;
                            input.required = true;
                            
                            formRow.appendChild(label);
                            formRow.appendChild(input);
                            addFormFields.appendChild(formRow);
                        }
                    });
                    
                    // Load table data
                    loadTableData();
                })
                .catch(error => {
                    console.error('Error loading columns:', error);
                    loading.textContent = 'Error loading data. Please try again later.';
                });
            
            // Load table data
            function loadTableData() {
                fetch(`${baseUrl}data`)
                    .then(response => response.json())
                    .then(data => {
                        // Clear table
                        tableBody.innerHTML = '';
                        
                        // Add data rows
                        data.data.forEach(record => {
                            const row = document.createElement('tr');
                            
                            columns.forEach(column => {
                                if (column !== 'id') {
                                    const cell = document.createElement('td');
                                    cell.textContent = record[column];
                                    row.appendChild(cell);
                                }
                            });
                            
                            // Add action buttons
                            const actionsCell = document.createElement('td');
                            actionsCell.className = 'actions';
                            
                            const editButton = document.createElement('button');
                            editButton.textContent = 'Edit';
                            editButton.className = 'btn-edit';
                            editButton.onclick = function() {
                                editRecord(record);
                            };
                            
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete';
                            deleteButton.className = 'btn-delete';
                            deleteButton.onclick = function() {
                                deleteRecord(record.id);
                            };
                            
                            actionsCell.appendChild(editButton);
                            actionsCell.appendChild(deleteButton);
                            row.appendChild(actionsCell);
                            
                            tableBody.appendChild(row);
                        });
                        
                        loading.style.display = 'none';
                        dataTable.style.display = 'table';
                    })
                    .catch(error => {
                        console.error('Error loading data:', error);
                        loading.textContent = 'Error loading data. Please try again later.';
                    });
            }
            
            // Show add form
            btnShowAddForm.addEventListener('click', function() {
                addFormContainer.classList.remove('hidden');
                btnShowAddForm.classList.add('hidden');
            });
            
            // Cancel add
            btnCancelAdd.addEventListener('click', function() {
                addFormContainer.classList.add('hidden');
                btnShowAddForm.classList.remove('hidden');
                addForm.reset();
            });
            
            // Cancel edit
            btnCancelEdit.addEventListener('click', function() {
                editFormContainer.classList.add('hidden');
                editForm.reset();
            });
            
            // Add record
            addForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(addForm);
                
                fetch(`${baseUrl}add`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addFormContainer.classList.add('hidden');
                        btnShowAddForm.classList.remove('hidden');
                        addForm.reset();
                        loadTableData();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error adding record:', error);
                    alert('Error adding record. Please try again.');
                });
            });
            
            // Edit record
            function editRecord(record) {
                // Clear previous form fields
                editFormFields.innerHTML = '';
                
                // Create form fields and populate with record data
                columns.forEach(column => {
                    if (column !== 'id') {
                        const formRow = document.createElement('div');
                        formRow.className = 'form-row';
                        
                        const label = document.createElement('label');
                        label.setAttribute('for', `edit_${column}`);
                        label.textContent = column;
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.id = `edit_${column}`;
                        input.name = column;
                        input.value = record[column];
                        input.required = true;
                        
                        formRow.appendChild(label);
                        formRow.appendChild(input);
                        editFormFields.appendChild(formRow);
                    }
                });
                
                // Set record ID for update
                editRecordId.value = record.id;
                
                // Show edit form
                editFormContainer.classList.remove('hidden');
            }
            
            // Update record
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = editRecordId.value;
                const updatedData = {};
                
                // Get form data
                columns.forEach(column => {
                    if (column !== 'id') {
                        updatedData[column] = document.getElementById(`edit_${column}`).value;
                    }
                });
                
                fetch(`${baseUrl}update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        data: updatedData
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        editFormContainer.classList.add('hidden');
                        loadTableData();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error updating record:', error);
                    alert('Error updating record. Please try again.');
                });
            });
            
            // Delete record
            function deleteRecord(id) {
                if (confirm('Are you sure you want to delete this record?')) {
                    fetch(`${baseUrl}delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: id
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadTableData();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting record:', error);
                        alert('Error deleting record. Please try again.');
                    });
                }
            }
        });
    </script>
</body>
</html>